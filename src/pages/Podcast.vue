<template>
  <section>
    <div class="podcast-logo">
      <svg viewBox="0 0 1540 283" fill="none" :class="['yoiSVG', { 'svganim': svgAnimated }]"
        xmlns="http://www.w3.org/2000/svg">
        <g class="yoisvg-logo">
          <rect width="70" height="170" rx="35" transform="translate(1436 100) rotate(30)" />
          <rect width="170" height="70" rx="35" transform="translate(1370 11)" />
          <rect width="170" height="70" rx="35" transform="translate(1329 182.224) rotate(-120)" />
        </g>
        <path class="yoisvg-logotype"
          d="M109.656 284H69.4375V220.859C60.5312 218.609 52.3281 215 44.8281 210.031C37.4219 205.062 31.0469 199.156 25.7031 192.312C20.3594 185.375 16.1875 177.734 13.1875 169.391C10.2812 160.953 8.82812 152.094 8.82812 142.812V82.3438H49.1875V142.812C49.1875 148.344 50.2188 153.594 52.2812 158.562C54.4375 163.438 57.3438 167.703 61 171.359C64.6562 175.016 68.9219 177.922 73.7969 180.078C78.7656 182.141 84.0156 183.172 89.5469 183.172C95.0781 183.172 100.281 182.141 105.156 180.078C110.125 177.922 114.438 175.016 118.094 171.359C121.75 167.703 124.609 163.438 126.672 158.562C128.828 153.594 129.906 148.344 129.906 142.812V82.3438H170.125V142.812C170.125 152.094 168.625 160.953 165.625 169.391C162.719 177.734 158.594 185.375 153.25 192.312C147.906 199.156 141.531 205.062 134.125 210.031C126.719 215 118.562 218.609 109.656 220.859V284ZM395.125 184.016C395.125 193.578 393.859 202.812 391.328 211.719C388.891 220.531 385.422 228.828 380.922 236.609C376.422 244.297 370.984 251.328 364.609 257.703C358.234 264.078 351.203 269.562 343.516 274.156C335.828 278.656 327.531 282.125 318.625 284.562C309.719 287.094 300.484 288.359 290.922 288.359C281.359 288.359 272.125 287.094 263.219 284.562C254.406 282.125 246.109 278.656 238.328 274.156C230.641 269.562 223.609 264.078 217.234 257.703C210.859 251.328 205.375 244.297 200.781 236.609C196.281 228.828 192.766 220.531 190.234 211.719C187.797 202.812 186.578 193.578 186.578 184.016C186.578 174.453 187.797 165.219 190.234 156.312C192.766 147.406 196.281 139.109 200.781 131.422C205.375 123.734 210.859 116.703 217.234 110.328C223.609 103.953 230.641 98.5156 238.328 94.0156C246.109 89.5156 254.406 86.0469 263.219 83.6094C272.125 81.0781 281.359 79.8125 290.922 79.8125C300.484 79.8125 309.719 81.0781 318.625 83.6094C327.531 86.0469 335.828 89.5156 343.516 94.0156C351.203 98.5156 358.234 103.953 364.609 110.328C370.984 116.703 376.422 123.734 380.922 131.422C385.422 139.109 388.891 147.406 391.328 156.312C393.859 165.219 395.125 174.453 395.125 184.016ZM355.047 184.016C355.047 175.203 353.359 166.906 349.984 159.125C346.609 151.25 342.016 144.453 336.203 138.734C330.484 132.922 323.688 128.328 315.812 124.953C308.031 121.578 299.734 119.891 290.922 119.891C282.016 119.891 273.672 121.578 265.891 124.953C258.109 128.328 251.312 132.922 245.5 138.734C239.688 144.453 235.094 151.25 231.719 159.125C228.344 166.906 226.656 175.203 226.656 184.016C226.656 192.828 228.344 201.125 231.719 208.906C235.094 216.594 239.688 223.344 245.5 229.156C251.312 234.969 258.109 239.562 265.891 242.938C273.672 246.312 282.016 248 290.922 248C299.734 248 308.031 246.312 315.812 242.938C323.688 239.562 330.484 234.969 336.203 229.156C342.016 223.344 346.609 216.594 349.984 208.906C353.359 201.125 355.047 192.828 355.047 184.016ZM462.062 284H421.703V82.3438H462.062V284ZM699.719 284H659.5V140C659.5 137.188 658.938 134.562 657.812 132.125C656.781 129.688 655.328 127.578 653.453 125.797C651.672 123.922 649.562 122.469 647.125 121.438C644.688 120.406 642.062 119.891 639.25 119.891C636.438 119.891 633.812 120.406 631.375 121.438C628.938 122.469 626.781 123.922 624.906 125.797C623.125 127.578 621.719 129.688 620.688 132.125C619.656 134.562 619.141 137.188 619.141 140V284H578.781V140C578.781 137.188 578.266 134.562 577.234 132.125C576.203 129.688 574.75 127.578 572.875 125.797C571.094 123.922 568.984 122.469 566.547 121.438C564.109 120.406 561.484 119.891 558.672 119.891C555.859 119.891 553.234 120.406 550.797 121.438C548.359 122.469 546.203 123.922 544.328 125.797C542.547 127.578 541.141 129.688 540.109 132.125C539.078 134.562 538.562 137.188 538.562 140V284H498.203V140C498.203 131.656 499.75 123.828 502.844 116.516C506.031 109.109 510.344 102.688 515.781 97.25C521.312 91.7188 527.734 87.4062 535.047 84.3125C542.453 81.125 550.328 79.5312 558.672 79.5312C566.172 79.5312 573.391 80.8906 580.328 83.6094C587.266 86.2344 593.5 90.0781 599.031 95.1406C604.562 90.0781 610.75 86.2344 617.594 83.6094C624.531 80.8906 631.75 79.5312 639.25 79.5312C647.594 79.5312 655.422 81.125 662.734 84.3125C670.141 87.4062 676.562 91.7188 682 97.25C687.531 102.688 691.844 109.109 694.938 116.516C698.125 123.828 699.719 131.656 699.719 140V284ZM776.219 284H735.859V82.3438H776.219V284ZM854.125 122.703V203.422H894.484C900.016 203.422 905.219 202.391 910.094 200.328C914.969 198.172 919.234 195.266 922.891 191.609C926.547 187.953 929.406 183.688 931.469 178.812C933.625 173.844 934.703 168.594 934.703 163.062C934.703 157.531 933.625 152.328 931.469 147.453C929.406 142.484 926.547 138.172 922.891 134.516C919.234 130.859 914.969 128 910.094 125.938C905.219 123.781 900.016 122.703 894.484 122.703H854.125ZM854.125 284H813.766V82.3438H894.484C901.891 82.3438 909.016 83.3281 915.859 85.2969C922.703 87.1719 929.078 89.8906 934.984 93.4531C940.984 96.9219 946.422 101.141 951.297 106.109C956.266 110.984 960.484 116.422 963.953 122.422C967.516 128.422 970.234 134.844 972.109 141.688C974.078 148.531 975.062 155.656 975.062 163.062C975.062 170 974.172 176.75 972.391 183.312C970.703 189.875 968.219 196.109 964.938 202.016C961.75 207.922 957.812 213.359 953.125 218.328C948.438 223.297 943.188 227.609 937.375 231.266L959.734 284H916.844L899.266 243.359L854.125 243.641V284ZM1160.69 203.422C1160.69 214.578 1158.58 225.078 1154.36 234.922C1150.14 244.672 1144.38 253.203 1137.06 260.516C1129.75 267.734 1121.17 273.453 1111.33 277.672C1101.58 281.891 1091.12 284 1079.97 284C1068.81 284 1058.31 281.891 1048.47 277.672C1038.72 273.453 1030.19 267.734 1022.88 260.516C1015.66 253.203 1009.94 244.672 1005.72 234.922C1001.5 225.078 999.391 214.578 999.391 203.422V82.3438H1039.61V203.422C1039.61 208.953 1040.64 214.156 1042.7 219.031C1044.86 223.906 1047.77 228.172 1051.42 231.828C1055.08 235.484 1059.34 238.391 1064.22 240.547C1069.19 242.609 1074.44 243.641 1079.97 243.641C1085.5 243.641 1090.7 242.609 1095.58 240.547C1100.55 238.391 1104.86 235.484 1108.52 231.828C1112.17 228.172 1115.03 223.906 1117.09 219.031C1119.25 214.156 1120.33 208.953 1120.33 203.422V82.3438H1160.69V203.422Z"
          transform="translate(-8 -38)" />
      </svg>

      <h2>{{ wtf }}</h2>
      <podcast-ext-links />
      <p>
        Yoimiru je podcast převážně o anime. Pravidelně se v náhodnou dobu scházíme a jdeme se pobavit o našich
        zážitcích při sledování tohoto média.
        Vždy se snažíme mluvit k věci a zbytečně epizody nenatahovat. To je lež. Smějeme se každé blbosti a navzájem po
        sobě házíme plyšáky.
      </p>
      <p>Yoimiru je na iTunes – ve vaší oblíbené podcastové aplikaci můžete Yoimiru odebírat a dostávat tak
        upozornění na nové epizody. Najdete nás také na Spotify a YouTube.</p>
    </div>

    <article class="podcast-episode" v-for="ep in podcasts" :key="ep.id">
      <div class="ep-bg" aria-hidden="true">
        <img :src="icon(ep.file)" aria-hidden="true">
        <div class="ep-bg-filter"></div>
      </div>
      <div class="ep-aside">
        <img :src="icon(ep.file)" :alt="'Obal ' + ep.epName" @click="playEpisode(ep)" @mousemove.passive="tilt">
      </div>
      <div class="ep-desc">
        <h3 class="ep-title" @click="playEpisode(ep)">{{ ep.epName }}</h3>
        <div class="ep-details">
          <div>{{ date(ep.id) }}</div>
          <div v-if="ep.chapters" class="ep-chap-indicator">
            <icon symbol="format-list-bulleted"></icon> Obsahuje kapitoly
          </div>
        </div>
        <p v-html="ep.epDesc"></p>
        <div class="ep-btns">
          <btn variant="red" icon="play" @click="playEpisode(ep)">Přehrát</btn>
          <btn variant="red" icon="link-variant" @click="copyLink(ep)"></btn>
        </div>
      </div>
    </article>

    <div style="text-align:center">
      <div style="color:white">Jste na konci. Nebo spíš na začátku.</div>
      <btn variant="red" icon="arrow-up-bold" @click="elevator">Zpátky nahoru</btn>
    </div>
  </section>
</template>

<script>
import API from 'api'
import moment from 'moment'
import cl from 'cloudinary-core'
import nano from '@/scripts/nano-scroll'
import tilt from '@/scripts/tilt'
import podcastExtLinks from '@/components/podcast-ext-links'
function getUrl (src, params) {
  const c = cl.Cloudinary.new({cloud_name: 'bio-senpai'})
  let parameters = {
    fetch_format: 'auto',
    height: 600,
    crop: 'scale',
    ...params
  }
  return c.url(src, parameters)
}

let wtfs = [
  'Podcast o anime aneb tři šílenci mluví o všem, co je napadne.',
  'Podcast o anime aneb tři šílenci se pokouší neumřít smíchy.',
  'Podcast o anime aneb tři šílenci šíří hodinu svého smíchu internetem.',
  'Podcast o anime aneb tři šílenci se hádají u mikrofonu o existenci příběhu v ečči.',
  'Podcast o anime aneb jak vyděsit turisty na rozhledně.',
  'Podcast o anime aneb pravá definice kulturistiky.',
  'Podcast o anime aneb Machy hraje intro na kytaru.',
  'Podcast o anime aneb sezónní postava v situaci.',
  'Podcast o anime aneb takovej českej šónen.'
]

export default {
  submenu: ['Projekty', 'Návrhy', 'Podcast'],
  data () {
    return {
      podcasts: []
    }
  },
  created () {
    this.fetchData()
  },
  mounted () {
    this.$emit('update:backdrop', 'podcast/banner')
  },
  beforeRouteLeave (to, from, next) {
    this.$emit('update:backdrop', '')
    next()
  },
  computed: {
    wtf () {
      return wtfs[Math.floor(Math.random() * wtfs.length)]
    },
    svgAnimated () {
      // Ugly hack
      return !!window.chrome
    }
  },
  methods: {
    fetchData () {
      this.$emit('error', false)
      new API('podcasts')
        .byIdDesc()
        .call()
        .then(res => {
          this.podcasts = res
          const linked = this.$route.query.e
          if (linked) {
            const ep = this.podcasts.find(e => e.file === `${linked}.mp3`)
            if (!ep) {
              this.$emit('error', 'Asi jste dostali špatný odkaz na epizodu podcastu.')
              return
            }
            const c = parseInt(this.$route.query.c) - 1
            if (c) {
              this.$emit('update:audio-chapter', c)
            }
            this.playEpisode(ep)
            this.$emit('ticker', `Přehrává se epizoda z odkazu: ${ep.epName}${c ? ' – ' + ep.chapters[c].name : ''}`)
          }
        })
        .catch(err => {
          this.$emit('error', err)
        })
    },
    playEpisode (ep) {
      this.$emit('update:audio', `//data.bio-senpai.ovi.moe/yoimiru/${ep.file}`)
      this.$emit('update:audio-meta', ep)
    },
    copyLink (ep) {
      const el = document.createElement('textarea')
      el.value = window.location.origin + window.location.pathname + `?e=${ep.file.substr(0, ep.file.length - 4)}`
      document.body.appendChild(el)
      el.select()
      document.execCommand('copy')
      document.body.removeChild(el)
      this.$emit('ticker', 'Odkaz na epizodu zkopírován.')
    },
    icon (file) {
      return getUrl('podcast/icons/' + file.substr(0, file.length - 4))
    },
    date (id) {
      return moment.unix(parseInt(id.toString().substring(0, 8), 16)).locale('cs').format('D.M.YYYY')
    },
    elevator () {
      nano(0)
    },
    tilt
  },
  components: {
    podcastExtLinks
  }
}
</script>

<style scoped lang="stylus">
@import "../stylus/unified-color"

ease-out-expo = cubic-bezier(0.19, 1, 0.22, 1)

.podcast-logo
  text-align center
  margin-bottom 3em

.yoiSVG
  fill white
  max-width 400px

@media all and (-webkit-min-device-pixel-ratio:0) and (min-resolution: .001dpcm)
  .svganim.yoiSVG rect
    &:nth-child(1)
      opacity 0
      animation r1 1s .3s ease-out-expo forwards
    &:nth-child(2)
      opacity 0
      animation r2 1s .5s ease-out-expo forwards
    &:nth-child(3)
      opacity 0
      animation r3 1s .4s ease-out-expo forwards

  @keyframes r1
    from
      transform translate(1488px, 11px) rotate(30deg)
    5%
      opacity 0
    to
      opacity 1
  @keyframes r2
    from
      transform translate(1259px, 11px)
    5%
      opacity 0
    to
      opacity 1
  @keyframes r3
    from
      transform translate(1374px, 282px) rotate(-120deg)
    5%
      opacity 0
    to
      opacity 1

  .svganim .yoisvg-logo
    transform translateX(-630px)
    animation g1 1s .6s ease-out-expo forwards
  .svganim .yoisvg-logotype
    transform translate(-438px, -38px)
    opacity 0
    animation g2 1s .6s ease-out-expo forwards

  @keyframes g1
    to
      transform translateX(0)
  @keyframes g2
    20%
      opacity 0
    to
      transform translate(-8px, -38px)
      opacity 1

.podcast-episode
  position relative
  display flex
  flex-wrap wrap
  padding 1.5em
  margin 1.5em 0
  border-radius 10px
  background-color lighten(#1e2430, 15%)
  z-index 1
  overflow hidden
  color white

.ep-bg
  position absolute
  top -2em
  left @top
  right @top
  bottom @top
  z-index -1
  filter blur(20px)
  img
    width 450px
    transition 1s
    object-fit cover
    opacity .65
  .ep-bg-filter
    position absolute
    top 0
    left 0
    width 500px
    height @width
    background: linear-gradient(-50deg, lighten(#1e2430, 15%) 40%, rgba(0, 0, 0, 0) 100%)

.ep-aside
  margin-right 2em
  flex 0 1 250px
  img
    --tilt-x 0deg
    --tilt-y 0deg
    --parallax-x 0px
    --parallax-y 0px
    width 100%
    border-radius 5px
    cursor pointer
    transition .5s
    &:hover
      transition .1s
      transform perspective(600px) rotateX(var(--tilt-y)) rotateY(var(--tilt-x))
  .ep-chap-indicator
    margin-top .5em
    font-size .9em

.ep-desc
  flex 1 1 300px

.ep-title
  cursor default
  margin .25em 0
  font-size 1.5em
  transition color .2s
  text-shadow 0 0 1em lighten(#1e2430, 15%), 0 0 1em lighten(#1e2430, 15%)

.podcast-episode:hover
  .ep-title
    color: lighten(ln(palette.red), 50%)
  .ep-bg img
    opacity .9
    transform scale(1.1) translateX(-1em)

.ep-details
  cursor default
  display flex
  justify-content flex-start
  gap 1em
  margin-bottom 1.5em
  font-size .9em
  font-weight bold
  opacity .8

.ep-btns
  display flex
  justify-content flex-start
  align-items center
  margin-top 1em
  .btn-icon-only
    font-size 1em
    padding 0.3em 0.4em

.tiles
  padding 1em
  left 0
  right 0
  margin 1em auto
  will-change width
  transition width 0.5s
.hidden
  opacity 0
  transition opacity .2s
</style>
